name: Daily Competition Data Update

on:
  schedule:
    - cron: '0 2 * * 1-5'  # 2 AM UTC, Monday-Friday
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Run type'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - test

env:
  PYTHON_VERSION: '3.9'
  STREAMLIT_APP_PATH: 'Kerdos/streamlit'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r Kerdos/requirements.txt
    
    - name: Verify Python scripts
      run: |
        cd Kerdos
        python -m py_compile run_competition_backtest.py
        echo "‚úÖ Scripts validated"

  update-competition-data:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r Kerdos/requirements.txt
    
    - name: Run competition backtest
      env:
        SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      run: |
        cd Kerdos
        echo "üìä Running competition backtest..."
        echo "Date range: Feb 28, 2026 - $(date -d yesterday '+%Y-%m-%d')"
        python run_competition_backtest.py
        echo "‚úÖ Competition data updated"

  notify:
    needs: [update-competition-data]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Report status
      run: |
        if [ "${{ needs.update-competition-data.result }}" == "success" ]; then
          echo "‚úÖ Daily backtest completed!"
          echo "üìä Competition data current through yesterday"
          echo "üåê View at: https://kerdos-fund.streamlit.app"
        else
          echo "‚ùå Backtest failed - check workflow logs"
          exit 1
        fi